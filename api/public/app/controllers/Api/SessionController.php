<?php namespace Api;

use Carbon\Carbon;
use Models\Session\Session;
use Models\Session\SessionEffectiveTime;
use Services\User\UserService;

/**
 * Class SessionController
 * @package Api;
 */
class SessionController extends BaseController
{
    /**
     * @var UserService $userService
     */
    protected $userService;

    public function initialize()
    {
        $this->userService = new UserService();
        parent::initialize(); // TODO: Change the autogenerated stub
    }

    /**
     * @param $userSlug
     * @return \Phalcon\Http\Response
     */
    public function newSessionForUserAction($userSlug)
    {
        if ($user = $this->userService->getUserBySlug($userSlug)) {

            $lastSession = $user->Sessions->getFirst();
            $date = Carbon::now();

            $hourDifference = false;

            if ($lastSession) {
                $lastSessionDate = Carbon::parse($lastSession->timestamp);
                $hourDifference = $lastSessionDate->diffInHours($date);
            }

            if ($hourDifference > 3 || !$lastSession || $lastSession->completed) {

                if ($lastSession) {
                    $lastSession->completed = 1;
                    $lastSession->update();
                }

                $session = new Session();
                $session->user_id = $user->id;
                $session->save();

                return $this->response(200, 'OK', ['message' => 'Session for ' . $date . ' created']);
            }

            return $this->response(200, 'OK', ['message' => 'Session for ' . $lastSession->timestamp . ' used']);
        }

        return $this->response(404, 'OK', ['message' => 'User not found']);
    }

    /**
     * @param $userSlug
     * @return \Phalcon\Http\Response
     */
    public function startGymEffectiveSessionAction($userSlug)
    {
        if ($user = $this->userService->getUserBySlug($userSlug)) {

            $lastSession = $user->Sessions->getFirst();

            $SessionEffectiveTime = new SessionEffectiveTime();
            $SessionEffectiveTime->user_id = $user->id;
            $SessionEffectiveTime->session_id = $lastSession->id;

            $SessionEffectiveTime->save();

            return $this->response(200, 'OK', ['message' => 'Active session created: ' . $SessionEffectiveTime->timestamp_start . '']);
        }
    }

    /**
     * @param $userSlug
     * @return \Phalcon\Http\Response
     */
    public function stopGymEffectiveSessionAction($userSlug)
    {
        if ($user = $this->userService->getUserBySlug($userSlug)) {

            $lastEffectiveTime = $user->EffectiveTimes->getFirst();

            if ($lastEffectiveTime || $lastEffectiveTime->timestamp_stop !== '') {

                $now = Carbon::now();

                $lastEffectiveTime->timestamp_stop = $now->format('Y-m-d H:i:s');
                $lastEffectiveTime->duration = Carbon::parse($lastEffectiveTime->timestamp_start)->diffInSeconds($now);
                $lastEffectiveTime->update();

                return $this->response(200, 'OK', ['message' => 'Last active session stopped at: ' . $lastEffectiveTime->timestamp_stop . '']);
            }

            return $this->response(200, 'OK', ['message' => 'Last active session was not found or already updated']);
        }
    }
}
